FROM datacore/pm2-discord as development
RUN apk add python3 build-base sqlite
RUN mkdir /app
WORKDIR /app
COPY --from=source package.json package-lock.json .
RUN npm install
COPY --from=source . .
RUN npm run build

ARG PROFILE_DATA_PATH
ARG DB_CONNECTION_STRING
ARG LOG_PATH
ARG STT_BOT_USERNAME
ARG STT_BOT_PASSWORD
ARG JWT_SECRET
ARG MONGO_CONN_STRING
ARG MONGO_DB_NAME
ARG MONGO_PROFILE_COLLECTION
ARG MONGO_TRACKED_VOYAGES_COLLECTION
ARG MONGO_TRACKED_ASSIGNMENTS_COLLECTION
ARG CORS_ORIGIN

RUN echo STT_BOT_USERNAME=$STT_BOT_USERNAME > .env
RUN echo STT_BOT_PASSWORD=$STT_BOT_PASSWORD >> .env
RUN echo JWT_SECRET=$JWT_SECRET >> .env
RUN echo DB_CONNECTION_STRING=$DB_CONNECTION_STRING >> .env
RUN echo MONGO_CONN_STRING=$MONGO_CONN_STRING >> .env
RUN echo MONGO_DB_NAME=$MONGO_DB_NAME >> .env
RUN echo MONGO_PROFILE_COLLECTION=$MONGO_PROFILE_COLLECTION >> .env
RUN echo MONGO_TRACKED_VOYAGES_COLLECTION=$MONGO_TRACKED_VOYAGES_COLLECTION >> .env
RUN echo MONGO_TRACKED_ASSIGNMENTS_COLLECTION=$MONGO_TRACKED_ASSIGNMENTS_COLLECTION >> .env
RUN echo CORS_ORIGIN=$CORS_ORIGIN >> .env
RUN echo PROFILE_DATA_PATH=$PROFILE_DATA_PATH >> .env
RUN echo LOG_PATH=$LOG_PATH >> .env
RUN cat .env && sleep 1s

CMD npm run start

FROM development as production
CMD pm2-runtime --name server start npm -- start